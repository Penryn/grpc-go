# Flow Control

流控是 gRPC 中的一项功能，它可以防止发送方在接收方无法处理的情况下向流中写入更多数据。此功能对客户端和服务器端的行为是相同的。由于 gRPC-Go 使用阻塞式 API 进行流操作，流控的回推通过在达到流控限制时简单地阻塞流上的发送操作来实现。当接收方从流中读取了足够的数据后，发送操作将自动解除阻塞。流控会根据连接的带宽延迟积（BDP）自动配置，以确保缓冲区的大小是允许流在接收方以最大速度读取时实现最大吞吐量所需的最小大小。

## 试一试

```
go run ./server
```

```
go run ./client
```

## 示例说明

示例客户端和服务器的编写是为了通过在另一方未接收消息时故意发送消息来演示阻塞。示例中的双向回显流首先让客户端发送消息，直到检测到它已被阻塞（利用另一个 goroutine）。服务器会休眠 2 秒以允许这种情况发生。然后服务器将读取所有这些消息，并交换客户端和服务器的角色，使服务器在客户端休眠时尝试连续发送。客户端休眠 2 秒后，将再次读取以解除服务器的阻塞。服务器将检测到它已被阻塞，并在解除阻塞后结束流。

### 预期输出

客户端输出应如下所示：
```
2023/09/19 15:49:49 新流开始。
2023/09/19 15:49:50 发送被阻塞。
2023/09/19 15:49:51 发送了 25 条消息。
2023/09/19 15:49:53 读取了 25 条消息。
2023/09/19 15:49:53 流成功结束。
```

而服务器应输出以下日志：

```
2023/09/19 15:49:49 新流开始。
2023/09/19 15:49:51 读取了 25 条消息。
2023/09/19 15:49:52 发送被阻塞。
2023/09/19 15:49:53 发送了 25 条消息。
2023/09/19 15:49:53 流成功结束。
```

